# 云端控制架构说明

## 📋 系统架构

### 数据流向
```
巴法云APP → ESP8266 → USART2中断 → wifi.rxbuff → DataAnylize() → 控制变量 → Process_Cloud_Control() → 硬件控制
```

## 🔧 核心模块

### 1. USART2中断处理 (`HardWare/esp8266.c`)
**功能：** 接收ESP8266发送的数据
```c
void USART2_IRQHandler(void) {
    // 接收数据到 wifi.rxbuff
    // 设置 wifi.rxover = 1 标志数据接收完成
}
```

### 2. DataAnylize() (`HardWare/esp8266.c`)
**功能：** 解析云端控制指令
- 检测控制主题（巴法云：tang2，阿里云：Message，本地：http）
- 支持多种JSON格式：
  - `topic=tang2&msg={"Relay":1}` （巴法云标准格式）
  - `tang2{"Relay":1}` （简化格式）
  - `{"Relay":1}` （纯JSON格式）
- 通过映射表 `name_flag_maps[]` 自动解析并更新控制变量

### 3. Menu_key_set() (`User/main.c`)
**功能：** 任务调度器中的按键扫描和数据处理
```c
void Menu_key_set(void) {
    if (wifi.rxover == 1) {
        DataAnylize();  // 处理ESP8266数据
    }
    // 按键扫描...
}
```

### 4. Process_Cloud_Control() (`User/main.c`)
**功能：** 检测控制变量变化并执行硬件控制
- 监控 `data.flag.motor_flag` 控制继电器
- 监控 `data.flag.led` 控制LED
- 可扩展更多控制逻辑

### 5. Test_ESP8266() (`User/main.c`)
**功能：** 监控和显示ESP8266状态（仅用于调试）
- 显示WiFi连接状态
- 显示云端连接状态
- 显示ESP8266调试信息
- **不参与业务逻辑处理**

## 📊 控制指令映射表

在 `HardWare/esp8266.c` 中定义：

```c
NameValueMap name_flag_maps[] = {
    // 设备控制
    {"Relay", TYPE_UINT16, {.u16 = &data.flag.motor_flag}},
    {"LED", TYPE_UINT8, {.u8 = &data.flag.led}},
    {"Buzzer", TYPE_UINT8, {.u8 = &data.flag.buzzer}},
    
    // 阈值设置
    {"TempThreshold", TYPE_FLOAT, {.f = &data.Threshold.Temp}},
    {"HumiThreshold", TYPE_FLOAT, {.f = &data.Threshold.Humi}},
    
    // 系统控制
    {"Mode", TYPE_UINT8, {.u8 = &data.flag.system_mode}},
    {"Reset", TYPE_UINT8, {.u8 = &data.flag.reset_flag}},
    {"RequestData", TYPE_UINT8, {.u8 = &data.flag.data_request}},
    {"Test", TYPE_UINT8, {.u8 = &data.flag.test_mode}},
};
```

## 🎯 使用方法

### 从巴法云APP发送控制指令

#### 1. 继电器控制
```json
{"Relay":1}  // 开启继电器
{"Relay":0}  // 关闭继电器
```

#### 2. LED控制
```json
{"LED":1}  // 开启LED
{"LED":0}  // 关闭LED
```

#### 3. 蜂鸣器控制
```json
{"Buzzer":1}  // 开启蜂鸣器
{"Buzzer":0}  // 关闭蜂鸣器
```

#### 4. 阈值设置
```json
{"TempThreshold":30.5}  // 设置温度阈值
{"HumiThreshold":70.0}  // 设置湿度阈值
```

#### 5. 组合控制
```json
{"Relay":1,"LED":1,"TempThreshold":25.0}
```

## 🔄 任务调度

```c
void Task_Initialization(void) {
    keyTaskID = Task_Add(Menu_key_set, 10, PRIORITY_CRITICAL, "KeyScan");
    // Menu_key_set 每10ms执行一次，处理ESP8266数据和按键扫描
    
    TaskID controlTaskID = Task_Add(Process_Cloud_Control, 100, PRIORITY_HIGH, "CloudControl");
    // Process_Cloud_Control 每100ms执行一次，检测控制变量变化
}
```

## 📝 移植指南

### 1. 添加新的控制指令

在 `HardWare/esp8266.c` 中：

```c
// 1. 在 main.h 中添加控制变量
typedef struct {
    // ...
    u8 new_device;  // 新设备控制标志
} flg;

// 2. 在映射表中添加映射
NameValueMap name_flag_maps[] = {
    // ...
    {"NewDevice", TYPE_UINT8, {.u8 = &data.flag.new_device}},
};

// 3. 在 Process_Cloud_Control() 中添加控制逻辑
void Process_Cloud_Control(void) {
    static uint8_t last_new_device = 0;
    
    if(data.flag.new_device != last_new_device) {
        if(data.flag.new_device > 0) {
            NewDevice_ON();
        } else {
            NewDevice_OFF();
        }
        last_new_device = data.flag.new_device;
    }
}
```

### 2. 更换云平台

修改 `HardWare/esp8266.c` 中的 `DataAnylize()` 函数：

```c
if(connected == 1) {
    // 巴法云
    topic = strstr((char*)wifi.rxbuff, "tang2");
} else if(connected == 2) {
    // 阿里云 - 修改为你的主题标识
    topic = strstr((char*)wifi.rxbuff, "YourTopic");
} else if(connected == 3) {
    // 本地服务器 - 修改为你的标识
    topic = strstr((char*)wifi.rxbuff, "YourIdentifier");
}
```

### 3. 移除调试功能

如果不需要 `Test_ESP8266()` 调试功能，在 `main()` 函数中注释掉：

```c
while(1) {
    // ...
    // Test_ESP8266();  // 注释掉这行
    Task_RunScheduler();
}
```

## ⚠️ 注意事项

1. **执行顺序很重要：** `Menu_key_set()` 必须在任务调度器中执行，确保优先处理数据
2. **不要在主循环中处理 `wifi.rxover`：** 避免与任务调度器冲突
3. **JSON格式必须正确：** 大小写敏感，必须使用双引号
4. **映射表类型匹配：** 确保JSON值类型与映射表中定义的类型一致

## 🎉 优势

1. **解耦设计：** 测试代码与业务逻辑完全分离
2. **易于扩展：** 通过映射表轻松添加新的控制指令
3. **多平台支持：** 支持巴法云、阿里云、本地服务器
4. **灵活的JSON格式：** 自动适配多种数据格式
5. **便于移植：** 清晰的模块划分，方便移植到其他项目
